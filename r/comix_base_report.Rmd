---
title: "CoMix social contact survey country report"
author: Amy Gimma, Kerry Wong, Kevin Van Zandvoort, LSHTM CMMID, Christopher Jarvis, John Edmunds
date: "`r format(Sys.time(), '%A %d %B %Y')`"
params:
  preset_variables: FALSE
  country_name_: NULL
  path_to_data: NULL
  truncate_contacts_n: NULL
  matrix_boots_n: NULL
output:
  # pdf_document: default
  html_document: default
  # word_document: default
---



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE )

message("PARAMS", params$country_name_)
# Loads libraries and data
library(here)
here::here()

# Read params, if set (no aftion if not)
if (!is.null(params$preset_variables)) {
  preset_variables <- params$preset_variables
}
if (!is.null(params$country_name_)) country_name_ <- params$country_name_
if (!is.null(params$path_to_data)) path_to_data <- params$path_to_data
if (!is.null(params$truncate_contacts_n)) {
  truncate_contacts_n <- params$truncate_contacts_n
}
if (!is.null(params$matrix_boots_n)) matrix_boots_n <- params$matrix_boots_n

source(file.path(here::here(), "r", "setup_report.R"))

```

## Country: `r country_name_`

## Introduction & Methods

CoMix is a behavioural survey, first launched on 24th of March 2020 in the UK, and launched in `r country_name_` on `r format(min(part$survey_date), "%d of %B %Y")`. The sample is broadly representative of the adult population in `r country_name_`. Participant’s are invited to respond to the survey approximately once every two weeks. In two waves, parents will complete the survey on behalf of a child in their household (17 years old or younger). Participants record direct, face-to-face contacts made on the previous day, specifying certain characteristics for each contact including the age and sex of the contact, whether contact was physical (skin-to-skin contact), and where contact occurred (e.g. at home, work, while undertaking leisure activities, etc). Further details have been published elsewhere[1]. The contact survey is based on the POLYMOD contact survey[2]. 

We calculated the crude mean number of contacts in the settings home, work and school (including all educational establishments, including childcare, nurseries and universities and colleges), and “other”  (mostly leisure and social contacts, but includes shopping). We look at the mean contacts by age and survey wave. The mean number of contacts is influenced by a few individuals who report very high numbers of contacts (often in a work context). We show means for all contacts and means calculated based on truncating the maximum number of contacts recorded at 50 per individual per day.

We calculated the mean contacts for the contact matrices by using the socialmixr R package [3], using `r matrix_boots_n` bootstrap samples. We constructed age-stratified contact matrices for nine age-groups (0-4, 5-11, 12-17, 18-29, 30-39, 40-49, 50-59, 60-69, and 70+). For children participants and contacts, we did not have exact ages and therefore sampled from the reported age-group uniformly. We fitted a truncated negative binomial model to calculate the mean contacts between each participant and contact age-groups. To find the population normalised symmetrical contact matrix, we multiplied the columns of the matrix by the mean-normalised proportion of the UK population in each age-group. 

 
## Results

### Timeline

There have been `r length(unique(part$wave))` waves of the survey covering from the period `r min(part$date)` to `r max(part$date)`

```{r timetable, fig.cap="Table 1: Timeline of survey rounds"}

timetable <- part %>% group_by(wave) %>% summarize(min_date = min(date), max_date = max(date), participants = n()) %>% ungroup()
# contacts <- contacts %>% ungroup()
count_contacts <- contacts %>% count(wave, name = "contacts")

timetable <- left_join(timetable, count_contacts)

names(timetable) <- c("Wave","Start date","End date", "Participants", "Contacts")

kable(t(timetable)) %>% kable_styling(full_width = F, position = "left")

```


Each wave can take place over different time periods. The number of reponses by day of contacts (24 hours prior to the survey) are shown in Figure 1 for each survey wave. 

```{r response_day_participants, fig.cap="Figure 1: Survey responses by date", fig.height= 4, fig.width= 6}

obs_per_date <- part %>% 
  count(wave, date)

ggplot(obs_per_date) +
  geom_col(aes(y = n, x = date)) +
  facet_wrap(. ~ wave, scales = "free_x") +
  scale_x_date(breaks = "2 day", expand = expansion(0)) +
  scale_y_continuous(expand = expansion(0)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.3)) +
  labs(y = "Number of participants", x = "Date of contact")


```



### Participant demographics

```{r participant_table, echo=FALSE}
part_summary_age <- part %>%
  count(wave, part_age_group) %>%
  group_by(wave) %>%
  mutate(prop = round(prop.table(n), 3)) %>%
  mutate(display = paste(n, " (", (prop * 100), "%)", sep = ""))

part_summary_gender <- part %>%
  count(wave, part_gender) %>%
  group_by(wave) %>%
  mutate(prop = round(prop.table(n), 3)) %>%
  mutate(display = paste(n, " (", (prop * 100), "%)", sep = ""))

part_summary_hh_size <- part %>% 
  count(wave, hh_size_group) %>%
  group_by(wave) %>%
  mutate(prop = round(prop.table(n), 3)) %>%
  mutate(display = paste(n, " (", (prop * 100), "%)", sep = ""))

# part_summary_pop_dens <- part %>%
#   count(wave, popul) %>%
#   group_by(wave) %>%
#   mutate(prop = round(prop.table(n), 3)) %>%
#   mutate(display = paste(n, " (", (prop * 100), "%)", sep = ""))


part_summary_display_age <- part_summary_age %>% 
  pivot_wider(id_cols = "part_age_group", names_from = "wave", values_from = "display", names_prefix = "Wave ") %>% 
  rename(Group = part_age_group) %>%
  mutate(Category = "Age")

part_summary_display_gender <- part_summary_gender %>%
  pivot_wider(id_cols = "part_gender", names_from = "wave", values_from = "display", names_prefix = "Wave ") %>%
  rename(Group = part_gender) %>%
  mutate(Category = "Gender",
         Group = case_when(
           Group == "female" ~ "Female",
           Group == "male" ~ "Male",
           is.na(Group) ~ "Missing"
         ))


part_summary_display_hh_size <- part_summary_hh_size %>% 
  pivot_wider(id_cols = "hh_size_group", names_from = "wave", values_from = "display", names_prefix = "Wave ") %>% 
  rename(Group = hh_size_group) %>%
  mutate(Category = "Household size")


all_summary <- part %>%
  count(wave) %>% mutate(Category = "All") %>%
  rename(display = n) %>%
  pivot_wider(id_cols = "Category", names_from = "wave", values_from = "display", names_prefix = "Wave ")

full_summary <- rbindlist(list(
  all_summary,
  part_summary_display_age,
  part_summary_display_gender,
  part_summary_display_hh_size), fill  = TRUE
) %>% relocate(Group, .after = Category)

full_summary[is.na(Group)]$Group <- ""

kable(full_summary) %>% kable_styling(full_width = F, position = "left")

# FOR WORD TABLES
# theme_vanilla(flextable(full_summary))
```

### Contact summaries


#### Contact setting

```{r contact_setting, echo = FALSE, fig.width = 7, fig.height = 4}

setting_all <- ggplot(
  contacts, 
  aes(y = factor(wave), fill = factor(cnt_setting))) + 
  geom_bar(position="fill", stat="count") +
  ylab("Wave") +
  xlab("Proportion") +
  labs(fill = "Contact setting") +
  coord_flip() +
  # scale_fill_manual(values = rev(fresh_pallette[c(2:6,8)]), guide = guide_legend(reverse = TRUE)) +
  ggtitle("All contacts \n(individually-reported + \n aggregated") +
  theme_bw() +
  theme(plot.title = element_text(size=12)) 

# total_time_all


setting_individual <- ggplot(
  contacts %>% filter(cnt_mass == "individual"), 
  aes(y = factor(wave), fill = factor(cnt_setting))) + 
  geom_bar(position="fill", stat="count") +
  ylab("Wave") +
  xlab("Proportion") +
  labs(fill = "Contact setting") +
  coord_flip() +
  ggtitle("All individually-reported contacts") +
  theme_bw() +
  theme(plot.title = element_text(size=12))

# total_time_non_household 

comb_setting <- (setting_all + setting_individual) + plot_layout(guides = "collect") 
comb_setting

cnt_summary_setting <- contacts %>%
  # filter(cnt_mass == "individual") %>%
  count(wave, cnt_setting) %>%
  group_by(wave) %>%
  mutate(prop = round(prop.table(n), 3)) %>%
  mutate(display = paste(n, " (", (prop * 100), "%)", sep = "")) %>%
  pivot_wider(id_cols = "cnt_setting", names_from = "wave", values_from = "display", names_prefix = "Wave ")  %>%
  rename("Group" = cnt_setting) %>%
  mutate(Category = "Contact setting") %>%
  relocate(Category, .before = Group)

# kable(cnt_summary_setting)  %>% kable_styling(full_width = F, position = "left")

```


#### Contact total time
```{r contact_duration, echo = FALSE, fig.width = 7, fig.height = 4}

total_time_all <- ggplot(
  contacts %>% filter(cnt_mass == "individual"), 
  aes(y = factor(wave), fill = factor(cnt_total_time))) + 
  geom_bar(position="fill", stat="count") +
  ylab("Wave") +
  xlab("Proportion") +
  labs(fill = "Contact time") +
  coord_flip() +
  # scale_fill_manual(values = rev(fresh_pallette[c(2:6,8)]), guide = guide_legend(reverse = TRUE)) +
  ggtitle("All individually- \nreported contacts") +
  theme_bw() +
  theme(plot.title = element_text(size=12))

# total_time_all


total_time_non_household <- ggplot(
  contacts %>% filter(cnt_mass == "individual" & cnt_household == 0), 
  aes(y = factor(wave), fill = factor(cnt_total_time))) + 
  geom_bar(position="fill", stat="count") +
  ylab("Wave") +
  xlab("Proportion") +
  labs(fill = "Contact time") +
  coord_flip() +
  # scale_fill_manual(values = rev(fresh_pallette[c(2:6,8)]), guide = guide_legend(reverse = TRUE)) +
  ggtitle("All contacts in \nnon-household settings") +
  theme_bw() +
  theme(plot.title = element_text(size=12))

# total_time_non_household 

comb_total_time <- (total_time_all + total_time_non_household) + plot_layout(guides = "collect")

comb_total_time 


cnt_summary_duration <- contacts %>%
  filter(cnt_mass == "individual") %>%
  count(wave, cnt_total_time) %>%
  group_by(wave) %>%
  mutate(prop = round(prop.table(n), 3)) %>%
  mutate(display = paste(n, " (", (prop * 100), "%)", sep = "")) %>%
  pivot_wider(id_cols = "cnt_total_time", names_from = "wave", values_from = "display", names_prefix = "Wave ")  %>%
  rename("Group" = cnt_total_time) %>%
  mutate(Category = "Contact time") %>%
  relocate(Category, .before = Group)
# kable(cnt_summary_duration)  %>% kable_styling(full_width = F, position = "left")

```

```{r cnt_summary_table, echo = FALSE}
cnt_summary_table <- rbindlist(list(cnt_summary_setting, cnt_summary_duration))

kable(cnt_summary_table) %>% 
  kable_styling(full_width = F, position = "left") 
```


#### Mean number of contacts

Crude mean contacts by participant age group for each wave.

```{r contact_means, echo=FALSE, message = FALSE, warning = FALSE}

all_mean <- contacts %>% 
  count(wave, part_id) %>%
  group_by(wave) %>%
  summarise("Mean contacts" = mean(n)) %>%
  mutate(Contacts = "All contacts", "Participant Age" = "All") 
 

trunc_mean <- trunc_contacts %>% 
  count(wave, part_id) %>%
  group_by(wave) %>%
  summarise("Mean contacts" = mean(n)) %>%
   mutate(Contacts = "Truncated to 50 contacts per participant", "Participant Age" = "All") 



all_mean_age <- contacts %>% 
  count(wave, part_id, part_age_group) %>%
  group_by(wave, part_age_group) %>%
  summarise("Mean contacts" = mean(n)) %>%
  mutate(Contacts = "All contacts") %>% 
  rename("Participant Age" = part_age_group)

trunc_mean_age <- trunc_contacts %>% 
  count(wave, part_id, part_age_group) %>%
  group_by(wave, part_age_group) %>%
  summarise("Mean contacts" = mean(n)) %>%
  mutate(Contacts = "Truncated to 50 contacts/participant") %>% 
  rename("Participant Age" = part_age_group) 

contact_means <- rbindlist(list(all_mean, trunc_mean, all_mean_age, trunc_mean_age), use.names = T) %>%
  rename(Wave = wave) %>%
  mutate("Mean contacts"= round(`Mean contacts`, 2)) %>%
  select("Wave", "Contacts", "Participant Age", "Mean contacts") 


contact_means_table <- contact_means %>%
  pivot_wider(id_cols = c("Contacts", "Participant Age"), 
              names_from = "Wave", 
              values_from = "Mean contacts", 
              names_prefix = "Wave ")

contact_means_ages <- contact_means %>% filter(`Participant Age` != "All") %>%
  mutate(Wave = paste("Wave", Wave))

ggplot(contact_means_ages, aes(x = `Participant Age`, y = `Mean contacts`,
       fill = `Participant Age`)) +
  geom_col(position = "dodge") +
  xlab("Partcipant age") +
  facet_grid(rows = vars(Contacts), cols = vars(factor(Wave))) +
  theme_bw() +
  ylab("Mean number of contacts")

kable(contact_means_table) %>%
  kable_styling(full_width = F, position = "left")
```


### Contact Matrices

Contact matrices are generated using the [socialmixr](https://github.com/sbfnk/socialmixr) R package. 

Contacts are sampled from within age groups weighted using the UN World Population Prospects estimates from 2015, the latest data available within the socialmixr package. 


```{r contact_matrices, echo=FALSE}
# Plot generated in `r/socialmixr_matrices.R`
source(file.path(here::here(), "r", "socialmixr_matrices.R"))

cm_plot
```


#### References

1. 	Jarvis CI, Van Zandvoort K, Gimma A, Prem K, CMMID COVID-19 working group, Klepac P, et al. Quantifying the impact of physical distance measures on the transmission of COVID-19 in the UK. BMC Med. 2020;18: 124.
2. 	Mossong J, Hens N, Jit M, Beutels P, Auranen K, Mikolajczyk R, et al. Social contacts and mixing patterns relevant to the spread of infectious diseases. PLoS Med. 2008;5: e74. 

3. Sebastian Funk (2020). socialmixr: Social Mixing Matrices for Infectious Disease Modelling. R package version 0.1.7.
