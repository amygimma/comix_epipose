---
title: "CoMix base report"
author: Amy Gimma, Kerry Wong, Kevin Van Zandvoort, CMMID, Christopher Jarvis, John Edmunds
date: "`r format(Sys.time(), '%A %d %B %Y')`"
output:
  # pdf_document: default
  html_document: default
  # word_document: default
---



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, error = FALSE, warning = FALSE, message = FALSE )

# Loads libraries and data
library(here)
here::here()
source(file.path(here::here(), "r", "setup_report.R"))

```


## Introduction

This is a report from the Epipose social contacts survey for your country. Participants reported the total number of direct contacts that they had on the day before the survey, which are people with whom they had at least a brief face-to-face conversation, or with whom they had any sort of skin-to-skin contact. 

## Timeline

There have been `r length(unique(part$wave))` waves of the survey covering from the period `r min(part$date)` to `r max(part$date)`

```{r timetable, fig.cap="Table 1: Timeline of survey rounds"}

timetable <- part %>% group_by(wave) %>% summarize(min_date = min(date), max_date = max(date), participants = n())

count_contacts <- contacts %>% count(wave, name = "contacts")

timetable <- left_join(timetable, count_contacts)

names(timetable) <- c("Wave","Start date","End date", "Participants", "Contacts")

kable(t(timetable)) %>% kable_styling(full_width = F, position = "left")

```


Each wave can take place over different time periods. The number of reponses by day of contacts (24 hours prior to the survey) are shown in Figure 1 for each survey wave. 

```{r response_day_participants, fig.cap="Figure 1: Survey responses by date", fig.height= 4, fig.width= 6}

obs_per_date <- part %>% 
  count(wave, date)

ggplot(obs_per_date) +
  geom_col(aes(y = n, x = date)) +
  facet_wrap(. ~ wave, scales = "free_x") +
  scale_x_date(breaks = "2 day", expand = expansion(0)) +
  scale_y_continuous(expand = expansion(0)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.3)) +
  labs(y = "Number of participants", x = "Date of contact")


```



## Participant demographics

```{r participant_table, echo=FALSE}
part_summary_age <- part %>%
  count(wave, part_age_group) %>%
  group_by(wave) %>%
  mutate(prop = round(prop.table(n), 3)) %>%
  mutate(display = paste(n, " (", (prop * 100), "%)", sep = ""))

part_summary_gender <- part %>%
  count(wave, part_gender) %>%
  group_by(wave) %>%
  mutate(prop = round(prop.table(n), 3)) %>%
  mutate(display = paste(n, " (", (prop * 100), "%)", sep = ""))

part_summary_hh_size <- part %>% 
  count(wave, hh_size_group) %>%
  group_by(wave) %>%
  mutate(prop = round(prop.table(n), 3)) %>%
  mutate(display = paste(n, " (", (prop * 100), "%)", sep = ""))

# part_summary_pop_dens <- part %>%
#   count(wave, popul) %>%
#   group_by(wave) %>%
#   mutate(prop = round(prop.table(n), 3)) %>%
#   mutate(display = paste(n, " (", (prop * 100), "%)", sep = ""))


part_summary_display_age <- part_summary_age %>% 
  pivot_wider(id_cols = "part_age_group", names_from = "wave", values_from = "display", names_prefix = "Wave ") %>% 
  rename(Group = part_age_group) %>%
  mutate(Category = "Age")

part_summary_display_gender <- part_summary_gender %>%
  pivot_wider(id_cols = "part_gender", names_from = "wave", values_from = "display", names_prefix = "Wave ") %>%
  rename(Group = part_gender) %>%
  mutate(Category = "Gender",
         Group = case_when(
           Group == "female" ~ "Female",
           Group == "male" ~ "Male",
           is.na(Group) ~ "Missing"
         ))


part_summary_display_hh_size <- part_summary_hh_size %>% 
  pivot_wider(id_cols = "hh_size_group", names_from = "wave", values_from = "display", names_prefix = "Wave ") %>% 
  rename(Group = hh_size_group) %>%
  mutate(Category = "Household size")


all_summary <- part %>%
  count(wave) %>% mutate(Category = "All") %>%
  rename(display = n) %>%
  pivot_wider(id_cols = "Category", names_from = "wave", values_from = "display", names_prefix = "Wave ")

full_summary <- rbindlist(list(
  all_summary,
  part_summary_display_age,
  part_summary_display_gender,
  part_summary_display_hh_size), fill  = TRUE
) %>% relocate(Group, .after = Category)

full_summary[is.na(Group)]$Group <- ""

kable(full_summary) %>% kable_styling(full_width = F, position = "left")

# FOR WORD TABLES
# theme_vanilla(flextable(full_summary))
```

## Contact summaries
#### Each contact was either individually enlisted (individually-reported contact) by the participants, or reported as part of a total number.

### Contact setting

```{r contact_setting, echo = FALSE, fig.width = 7, fig.height = 4}

setting_all <- ggplot(
  contacts, 
  aes(y = factor(wave), fill = factor(cnt_setting))) + 
  geom_bar(position="fill", stat="count") +
  ylab("Wave") +
  xlab("Proportion") +
  labs(fill = "Contact setting") +
  coord_flip() +
  # scale_fill_manual(values = rev(fresh_pallette[c(2:6,8)]), guide = guide_legend(reverse = TRUE)) +
  ggtitle("All contacts \n(individually-reported + \n aggregated") +
  theme_bw() +
  theme(plot.title = element_text(size=12)) 

# total_time_all


setting_individual <- ggplot(
  contacts %>% filter(cnt_mass == "individual"), 
  aes(y = factor(wave), fill = factor(cnt_setting))) + 
  geom_bar(position="fill", stat="count") +
  ylab("Wave") +
  xlab("Proportion") +
  labs(fill = "Contact setting") +
  coord_flip() +
  ggtitle("All individually-reported contacts") +
  theme_bw() +
  theme(plot.title = element_text(size=12))

# total_time_non_household 

comb_setting <- (setting_all + setting_individual) + plot_layout(guides = "collect") 
comb_setting

cnt_summary_setting <- contacts %>%
  # filter(cnt_mass == "individual") %>%
  count(wave, cnt_setting) %>%
  group_by(wave) %>%
  mutate(prop = round(prop.table(n), 3)) %>%
  mutate(display = paste(n, " (", (prop * 100), "%)", sep = "")) %>%
  pivot_wider(id_cols = "cnt_setting", names_from = "wave", values_from = "display", names_prefix = "Wave ")  %>%
  rename("Group" = cnt_setting) %>%
  mutate(Category = "Contact setting") %>%
  relocate(Category, .before = Group)

# kable(cnt_summary_setting)  %>% kable_styling(full_width = F, position = "left")

```


### Contact total time
```{r contact_duration, echo = FALSE, fig.width = 7, fig.height = 4}

total_time_all <- ggplot(
  contacts %>% filter(cnt_mass == "individual"), 
  aes(y = factor(wave), fill = factor(cnt_total_time))) + 
  geom_bar(position="fill", stat="count") +
  ylab("Wave") +
  xlab("Proportion") +
  labs(fill = "Contact time") +
  coord_flip() +
  # scale_fill_manual(values = rev(fresh_pallette[c(2:6,8)]), guide = guide_legend(reverse = TRUE)) +
  ggtitle("All individually- \nreported contacts") +
  theme_bw() +
  theme(plot.title = element_text(size=12))

# total_time_all


total_time_non_household <- ggplot(
  contacts %>% filter(cnt_mass == "individual" & cnt_household == 0), 
  aes(y = factor(wave), fill = factor(cnt_total_time))) + 
  geom_bar(position="fill", stat="count") +
  ylab("Wave") +
  xlab("Proportion") +
  labs(fill = "Contact time") +
  coord_flip() +
  # scale_fill_manual(values = rev(fresh_pallette[c(2:6,8)]), guide = guide_legend(reverse = TRUE)) +
  ggtitle("All contacts in \nnon-household settings") +
  theme_bw() +
  theme(plot.title = element_text(size=12))

# total_time_non_household 

comb_total_time <- (total_time_all + total_time_non_household) + plot_layout(guides = "collect")

comb_total_time 


cnt_summary_duration <- contacts %>%
  filter(cnt_mass == "individual") %>%
  count(wave, cnt_total_time) %>%
  group_by(wave) %>%
  mutate(prop = round(prop.table(n), 3)) %>%
  mutate(display = paste(n, " (", (prop * 100), "%)", sep = "")) %>%
  pivot_wider(id_cols = "cnt_total_time", names_from = "wave", values_from = "display", names_prefix = "Wave ")  %>%
  rename("Group" = cnt_total_time) %>%
  mutate(Category = "Contact time") %>%
  relocate(Category, .before = Group)
# kable(cnt_summary_duration)  %>% kable_styling(full_width = F, position = "left")

```

```{r cnt_summary_table, echo = FALSE}
cnt_summary_table <- rbindlist(list(cnt_summary_setting, cnt_summary_duration))

kable(cnt_summary_table) %>% 
  kable_styling(full_width = F, position = "left") 
```


## Mean number of contacts

```{r contact_means, echo=FALSE, message = FALSE, warning = FALSE}

all_mean <- contacts %>% 
  count(wave, part_id) %>%
  group_by(wave) %>%
  summarise("Mean contacts" = mean(n)) %>%
  mutate(Contacts = "All contacts", "Participant Age" = "All") 
 

trunc_mean <- trunc_contacts %>% 
  count(wave, part_id) %>%
  group_by(wave) %>%
  summarise("Mean contacts" = mean(n)) %>%
   mutate(Contacts = "Truncated to 50 contacts per participant", "Participant Age" = "All") 



all_mean_age <- contacts %>% 
  count(wave, part_id, part_age_group) %>%
  group_by(wave, part_age_group) %>%
  summarise("Mean contacts" = mean(n)) %>%
  mutate(Contacts = "All contacts") %>% 
  rename("Participant Age" = part_age_group)

trunc_mean_age <- trunc_contacts %>% 
  count(wave, part_id, part_age_group) %>%
  group_by(wave, part_age_group) %>%
  summarise("Mean contacts" = mean(n)) %>%
  mutate(Contacts = "Truncated to 50 contacts/participant") %>% 
  rename("Participant Age" = part_age_group) 

contact_means <- rbindlist(list(all_mean, trunc_mean, all_mean_age, trunc_mean_age), use.names = T) %>%
  rename(Wave = wave) %>%
  mutate("Mean contacts"= round(`Mean contacts`, 2)) %>%
  select("Wave", "Contacts", "Participant Age", "Mean contacts") 


contact_means_table <- contact_means %>%
  pivot_wider(id_cols = c("Contacts", "Participant Age"), 
              names_from = "Wave", 
              values_from = "Mean contacts", 
              names_prefix = "Wave ")

contact_means_ages <- contact_means %>% filter(`Participant Age` != "All") %>%
  mutate(Wave = paste("Wave", Wave))

ggplot(contact_means_ages, aes(x = `Participant Age`, y = `Mean contacts`,
       fill = `Participant Age`)) +
  geom_col(position = "dodge") +
  xlab("Partcipant age") +
  facet_grid(rows = vars(Contacts), cols = vars(factor(Wave))) +
  theme_bw() +
  ylab("Mean number of contacts")

kable(contact_means_table) %>%
  kable_styling(full_width = F, position = "left")
```


<!-- ## Contact Matrices -->

```{r contact_matrices, echo=FALSE}
# age_limits_ <- c(18, 30, 40, 50, 60, 70, 120)
# pop_data <- qread(file.path(here(),"pop_data", "unwpp_data.qs"))
# pop_data <- pop_data %>% filter(country == part$country & year == 2020)
# 
# age_limits <- seq(15, 100, 5)
# c_cm <- contacts %>% 
#   filter(cnt_mass == "individual" ) %>%
#   select("part_id", "cont_id", "cnt_age_est_min","cnt_age_est_max", "cnt_gender",
#          "cnt_home", "cnt_work", "cnt_school")
# 
# p_cm <- part %>% 
#   select("part_id",  "part_age", "part_gender", "hh_size")
         # "dayofweek")

# c_cm %>% rename(cnt_age_exact cnt_age_est_min cnt_age_est_max)
# comix_survey <- socialmixr::survey(part, c_cm)
# comix_cm <- socialmixr::contact_matrix(comix_survey, 
                                       # survey.pop = pop_data,
                                       # age.limits = age_limits_,
                                       # symmetric = T)

```
