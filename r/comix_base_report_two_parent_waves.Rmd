---
params:
  preset_variables: FALSE
  country_name_: NULL
  path_to_data: NULL
  truncate_contacts_n: NULL
  matrix_boots_n: NULL
output:
  html_document: default
---

<style>
    body .main-container {
        width: 775px;
    }
</style>


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE )

message(paste("params$country_name_:", params$country_name_))
# Loads libraries and data
library(RColorBrewer)
library(ggthemes)
library(here)
here::here()

# Read params, if set (no aftion if not)
if (!is.null(params$preset_variables)) {
  preset_variables <- params$preset_variables
}
if (!is.null(params$country_name_)) country_name_ <- params$country_name_
if (!is.null(params$path_to_data)) path_to_data <- params$path_to_data
if (!is.null(params$truncate_contacts_n)) {
  truncate_contacts_n <- params$truncate_contacts_n
}
if (!is.null(params$matrix_boots_n)) matrix_boots_n <- params$matrix_boots_n

source(here::here("r", "setup_report.R"))

```
<!-- ![](media/logo-EpiPose-header.jpg) -->
<!-- {width=50px style="display: block; margin:0 auto;"} -->


```{r header_png, out.width="40%"}
knitr::include_graphics(here::here("media", "epipose_logo_rectangle.png"))
```

# CoMix social contact survey: Report for `r country_name_` rounds 1 to `r max(part$round)`

*Amy Gimma, Kerry Wong, Kevin Van Zandvoort, CMMID COVID-19 Working Group, Christopher Jarvis, John Edmunds*
London school of Hygiene and Tropical Medicine.

Created as part of the EpiPose project, funded by the EU Horizon 2020 Research and Innovations Programme - project EpiPose (Epidemic Intelligence to Minimize COVID-19’s Public Health, Societal and Economical Impact, No 101003688).

<strong>Report created:</strong> `r format(Sys.time(), '%d %B %Y')` <br>
<strong>Survey dates:</strong> `r format(min(part$survey_date), '%d %B %Y')` to `r format(max(part$survey_date), '%d %B %Y')`


### Introduction & Methods

<br/>

CoMix is a behavioural survey, first launched on 24th of March 2020 in the UK, and launched in `r country_name_` on `r format(min(part$survey_date), "%d of %B %Y")`. The sample is broadly representative of the adult population in `r country_name_`. Participant’s are invited to respond to the survey approximately once every two weeks. In two waves, parents will complete the survey on behalf of a child in their household (17 years old or younger). Participants record direct, face-to-face contacts made on the previous day, specifying certain characteristics for each contact including the age and sex of the contact, whether contact was physical (skin-to-skin contact), and where contact occurred (e.g. at home, work, while undertaking leisure activities, etc). Participants are instructed to report contacts individually, but are also given the opportunity to report aggregated estimates of contacts by age group and setting in case they did not list all contacts individually. Further details have been published elsewhere[1,2]. The contact survey is based on the POLYMOD contact survey[3]. 

We calculated and plotted the crude mean number of contacts by setting, duration, and participant to contact age groups. We used the settings home, work and school (including all educational establishments, including childcare, nurseries and universities and colleges), and “other”  (mostly leisure and social contacts, but includes shopping), and report . We look at the mean contacts by age and survey wave. The mean number of contacts is influenced by a few individuals who report very high numbers of contacts (often in a work context). We show means for all contacts and means number of contacts after truncating the maximum number of contacts recorded at 50 per individual per day.

We calculated the mean contacts for the contact matrices by using the socialmixr R package [4], with `r matrix_boots_n` bootstrapped samples. We used the World Population Prospect data from 2015 for country specific population estimates  by age and gender, which is the latest available data in the socialmixr package. We constructed age-stratified contact matrices for nine age-groups (0-4, 5-11, 12-17, 18-29, 30-39, 40-49, 50-59, 60-69, and 70+). For contacts, we do not have exact ages and therefore sampled from the reported age-group. The first round of data collected for children's contacts (Panel C, Wave 1) has been used to complete symmetric contact matrices in all previous waves. Children's contacts may have changed over time, especially depending on school attendence status, so this should be considered if there have been changes throughout the survey period.

 <br/>

### Timeline

The CoMix survey in `r country_name_` has had `r length(unique(part$wave))` waves of data collection covering from the period `r format(min(part$survey_date), "%d of %B %Y")` to `r format(max(part$survey_date), "%d of %B %Y")`. Figure 1 shows survey response by date.

```{r timetable, fig.cap="Table 1: Timeline of survey rounds"}

timetable <- part %>% group_by(wave_id) %>% 
  summarize(min_date = format(min(survey_date), "%d %b %Y"), 
            max_date = format(max(survey_date), "%d %b %Y"), 
            participants = n()) %>% 
  ungroup()

count_contacts <- contacts %>% count(wave_id, name = "contacts")

timetable <- left_join(timetable, count_contacts)

names(timetable) <- c("Wave","Start date","End date", "Participants", "Contacts")

kable(t(timetable)) %>% 
  kable_styling(full_width = F, position = "left", font_size = 12)

```
<strong>Table 1. Survey wave summary.</strong> Survey wave start and end dates, number of participants, and number of contacts.

<br/>

<strong>Figure 1: Survey responses by date.</strong>

```{r response_day_participantsbl, fig.height=4, fig.width=10}
obs_per_date <- part %>% 
  count(wave_id, survey_date, went_to_school) %>%
  mutate(survey_date) %>% 
  mutate(went_to_school)

ggplot(obs_per_date) +
  geom_col(aes(y = n, x = survey_date, fill = went_to_school)) +
  facet_grid(. ~ wave_id, scales = "free_x", space = "free_x") +
  scale_x_date(breaks = "2 day", 
               expand = expansion(0), 
               date_labels = "%d %b %y") +
  labs(y = "Number of participants", x = "Date of contact") + 
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.3)) 



```

<br/>

### Participant demographics

<br/>

```{r participant_table, echo=FALSE}

part_summary_age <- part %>%
  count(wave_id, part_age_group) %>%
  group_by(wave_id) %>%
  mutate(prop = prop.table(n), 3) %>%
  mutate(display = paste(n, " (", format_n(prop * 100), "%)", sep = ""))

part_summary_gender <- part %>%
  count(wave_id, part_gender) %>%
  group_by(wave_id) %>%
  mutate(prop = round(prop.table(n), 3)) %>%
  mutate(display = paste(n, " (", format_n(prop * 100), "%)", sep = ""))

part_summary_hh_size <- part %>% 
  count(wave_id, hh_size_group) %>%
  group_by(wave_id) %>%
  mutate(prop = round(prop.table(n), 3)) %>%
  mutate(display = paste(n, " (", format_n(prop * 100), "%)", sep = ""))

# part_summary_pop_dens <- part %>%
#   count(wave_id, popul) %>%
#   group_by(wave_id) %>%
#   mutate(prop = round(prop.table(n), 3)) %>%
#   mutate(display = paste(n, " (", (prop * 100), "%)", sep = ""))


part_summary_display_age <- part_summary_age %>% 
  pivot_wider(id_cols = "part_age_group", names_from = "wave_id", values_from = "display", names_prefix = "Wave ") %>% 
  rename(Group = part_age_group) %>%
  mutate(Category = "Age") %>%
  arrange(Group)

part_summary_display_gender <- part_summary_gender %>%
  pivot_wider(id_cols = "part_gender", names_from = "wave_id", values_from = "display", names_prefix = "Wave ") %>%
  rename(Group = part_gender) %>%
  mutate(Category = "Gender",
         Group = case_when(
           Group == "female" ~ "Female",
           Group == "male" ~ "Male",
           is.na(Group) ~ "Other or Missing"
         ))


part_summary_display_hh_size <- part_summary_hh_size %>% 
  pivot_wider(id_cols = "hh_size_group", names_from = "wave_id", values_from = "display", names_prefix = "Wave ") %>% 
  rename(Group = hh_size_group) %>%
  mutate(Category = "Household size")


all_summary <- part %>%
  count(wave_id) %>% mutate(Category = "All") %>%
  rename(display = n) %>%
  pivot_wider(id_cols = "Category", names_from = "wave_id", values_from = "display", names_prefix = "Wave ")

full_summary <- rbindlist(list(
  all_summary,
  part_summary_display_age,
  part_summary_display_gender,
  part_summary_display_hh_size), fill  = TRUE
) %>% relocate(Group, .after = Category)

full_summary[is.na(Group)]$Group <- ""

kable(full_summary) %>% 
  kable_styling(full_width = F, position = "left", font_size = 12) %>%
  collapse_rows(columns = 1, valign = "top")

# FOR WORD TABLES
# theme_vanilla(flextable(full_summary))
```

<strong>Table 2. Participant demographics by wave for age, gender, and household size.</strong>

<br/>

### Children sample school attendance

<br/>

```{r child_school_attend_table, echo=FALSE}
child_sch_attendence <- part %>% filter(panel=="C" & !is.na(part_age_group)) %>% 
  mutate(part_attend_school_yesterday = ifelse(is.na(part_attend_school_yesterday), "NA", part_attend_school_yesterday)) %>% 
  mutate(part_attend_school_yesterday = ifelse(part_attend_school_yesterday == "Prefer not to answer", "NA", part_attend_school_yesterday)) %>%
  mutate(part_attend_school_yesterday = ifelse(part_attend_school_yesterday == "Don’t know", "NA", part_attend_school_yesterday)) 

school_table <- child_sch_attendence %>% 
  group_by(wave_id, part_age_group) %>% 
  count(part_attend_school_yesterday) %>% 
  mutate(prop = prop.table(n), 3) %>%
  mutate(display = paste(n, " (", format_n(prop * 100), "%)", sep = ""))

school_table_no <- child_sch_attendence %>% 
  group_by(wave_id, part_age_group) %>% 
  count(went_to_school) %>% 
  mutate(prop = prop.table(n), 3) %>%
  mutate(display = paste(n, " (", format_n(prop * 100), "%)", sep = "")) %>% 
  filter(went_to_school == "No") %>% 
  rename(part_attend_school_yesterady = went_to_school) 
  
school_table <- rbindlist(list(school_table, school_table_no)) %>% 
  arrange(wave_id, part_age_group, part_attend_school_yesterday)

school_table_display <- school_table %>% 
  pivot_wider(id_cols = c("wave_id","part_attend_school_yesterday"), names_from = "part_age_group", values_from = "display", names_prefix = "Age ") %>% 
  pivot_wider(id_cols = "part_attend_school_yesterday", names_from = "wave_id", values_from = c("Age 0-4", "Age 5-17"), names_prefix = "Wave ")

school_all_table <- child_sch_attendence %>% 
  group_by(wave_id) %>% 
  count(part_attend_school_yesterday) %>% 
  mutate(prop = prop.table(n), 3) %>%
  mutate(display = paste(n, " (", format_n(prop * 100), "%)", sep = ""))

school_all_table_no <- child_sch_attendence %>% 
  group_by(wave_id) %>% 
  count(went_to_school) %>% 
  mutate(prop = prop.table(n), 3) %>%
  mutate(display = paste(n, " (", format_n(prop * 100), "%)", sep = "")) %>% 
  filter(went_to_school == "No") %>% 
  rename(part_attend_school_yesterady = went_to_school) 

school_all_table <- rbindlist(list(school_all_table, school_all_table_no)) %>% 
  arrange(wave_id, part_attend_school_yesterday)
    
school_all_table_display <- school_all_table %>% 
  pivot_wider(id_cols = c("wave_id","part_attend_school_yesterday"), names_from = "wave_id", values_from = "display", names_prefix = "Age ") 

school_merge_table_display <- merge(school_all_table_display, school_table_display,
                                    by = "part_attend_school_yesterday")
school_merge_table_display <- school_merge_table_display %>% 
  relocate(c("Age C2", "Age 0-4_Wave C2", "Age 5-17_Wave C2"), .after = "Age 5-17_Wave C1")

names(school_merge_table_display) <- c("Attendence at school",
                                 "Wave C1 (0-17)", "Wave C1 (0-4)","Wave C1 (5-17)",
                                 "Wave C2 (0-17)", "Wave C2 (0-4)","Wave C2 (5-17)")

kable(school_merge_table_display) %>% 
  kable_styling(full_width = F, position = "left", font_size = 12) %>% 
  row_spec(which(school_table_display$part_attend_school_yesterday=="No"), bold = T) %>%
  row_spec(which(school_table_display$part_attend_school_yesterday=="Yes"), bold = T) %>%
  row_spec(which(school_table_display$part_attend_school_yesterday=="NA"), bold = T)
```

<strong> Table 2.2 School attendance of children on the day before survey by age

<br/>

### Contact characteristics

<br/>

#### Contact setting

<br/>

<strong>Figure 2. Proportion of contacts by setting and wave.</strong> A) All contacts (both individually-reported and reported in aggregated contact questions); B) individually-reported contacts only.

```{r contact_setting, echo = FALSE, fig.width = 10, fig.height = 8}
contacts <- contacts %>% 
  mutate(barw = case_when(panel=="A" ~ 3, panel == "C" ~ 1))

setting_all <- ggplot(
  contacts, 
  aes(y = factor(wave_id), fill = factor(cnt_setting))) + 
  geom_bar(position="fill", stat="count") +
  ylab("") +
  xlab("Proportion") +
  labs(fill = "Contact setting") +
  scale_y_discrete(expand = c(0,0)) + scale_x_continuous(expand = c(0,0)) +
  coord_flip() +
  # scale_fill_manual(values = rev(fresh_pallette[c(2:6,8)]), guide = guide_legend(reverse = TRUE)) +
  ggtitle("A1. All contacts") +
  theme_bw() +
  theme(plot.title = element_text(size=12),
        axis.ticks.x = element_blank(),
        plot.background = element_blank()) 

setting_all_sch <- ggplot(
  contacts, 
  aes(y = factor(went_to_school), fill = factor(cnt_setting))) + 
  geom_bar(position="fill", stat="count") +
  facet_grid(. ~ wave_id, scale = "free", switch = "both") +
  ylab("Did child go to school the day before survey?") +
  xlab("Proportion") +
  labs(fill = "Contact setting") +
  scale_y_discrete(expand = c(0,0)) + scale_x_continuous(expand = c(0,0)) +
  coord_flip() +
  # scale_fill_manual(values = rev(fresh_pallette[c(2:6,8)]), guide = guide_legend(reverse = TRUE)) +
  ggtitle("A2. All contacts") +
  theme_bw() +
  theme(plot.title = element_text(size=12),
        strip.background = element_blank(), 
        axis.text.x = element_text(angle=-5),  
        axis.ticks.x = element_blank())

setting_individual <- ggplot(
  contacts %>% filter(cnt_mass == "individual"), 
  aes(y = factor(wave_id), fill = factor(cnt_setting))) + 
  geom_bar(position="fill", stat="count") +
  ylab("") +
  xlab("Proportion") +
  labs(fill = "Contact setting") +
  scale_y_discrete(expand = c(0,0)) + scale_x_continuous(expand = c(0,0)) +
  coord_flip() +
  ggtitle("B1. Individually-reported contacts") +
  theme_bw() +
  theme(plot.title = element_text(size=12),
        axis.ticks.x = element_blank(),
        plot.background = element_blank())

# total_time_all
setting_individual_sch <- ggplot(
  contacts %>% filter(cnt_mass == "individual"), 
  aes(y = factor(went_to_school), fill = factor(cnt_setting))) + 
  geom_bar(position="fill", stat="count") +
  facet_grid(. ~ wave_id, scale = "free", switch = "both") +
  ylab("Did child go to school the day before survey?") +
  xlab("Proportion") +
  labs(fill = "Contact setting") +
  scale_y_discrete(expand = c(0,0)) + scale_x_continuous(expand = c(0,0)) +
  coord_flip() +
  ggtitle("B2. Individually-reported contacts") +
  theme_bw() +
  theme(plot.title = element_text(size=12),
        strip.background = element_blank(), 
        axis.text.x = element_text(angle=-5),  
        axis.ticks.x = element_blank())

# total_time_non_household 

comb_setting <- (setting_all + setting_individual + 
                 setting_all_sch + setting_individual_sch) + plot_layout(guides = "collect") 
comb_setting

cnt_summary_setting <- contacts %>%
  count(wave_sch_id, cnt_setting) %>%
  group_by(wave_sch_id) %>%
  mutate(prop = round(prop.table(n), 3)) %>%
  mutate(display = paste(n, " (", format_n(prop * 100), "%)", sep = "")) %>%
  pivot_wider(id_cols = "cnt_setting", names_from = "wave_sch_id", values_from = "display", names_prefix = "Wave ")  %>%
  rename("Group" = cnt_setting) %>%
  mutate(Category = "Contact setting") %>%
  relocate(Category, .before = Group)

cnt_summary_setting_c <- contacts %>%
  filter(panel == "C") %>% 
  count(wave_id, cnt_setting) %>%
  group_by(wave_id) %>%
  mutate(prop = round(prop.table(n), 3)) %>%
  mutate(display = paste(n, " (", format_n(prop * 100), "%)", sep = "")) %>%
  pivot_wider(id_cols = "cnt_setting", names_from = "wave_id", values_from = "display", names_prefix = "Wave ")  %>%
  rename("Group" = cnt_setting) %>%
  mutate(Category = "Contact setting") %>%
  relocate(Category, .before = Group)

cnt_summary_setting <- merge(cnt_summary_setting, cnt_summary_setting_c, 
                             by = c("Category", "Group")) %>% 
  relocate("Wave C1", .before = "Wave C1 NA") %>% 
  relocate("Wave C2", .before = "Wave C2 NA") 

# kable(cnt_summary_setting)  %>% kable_styling(full_width = F, position = "left")

```

<br/>

#### Contact duration

<br/>

<strong>Figure 3. Proportion of contacts by duration of contact and wave.</strong> A) All individually-reported contacts; B) individually-reported contacts, excluding the participant's household members.

```{r contact_duration, echo = FALSE, fig.width = 10, fig.height = 8}

total_time_all <- ggplot(
  contacts %>% filter(cnt_mass == "individual"), 
  aes(y = factor(wave_id), fill = factor(cnt_total_time))) + 
  geom_bar(position="fill", stat="count") +
  ylab("") +
  xlab("Proportion") +
  labs(fill = "Contact time") +
  scale_y_discrete(expand = c(0,0)) + scale_x_continuous(expand = c(0,0)) +
  coord_flip() +
  # scale_fill_manual(values = rev(fresh_pallette[c(2:6,8)]), guide = guide_legend(reverse = TRUE)) +
  ggtitle("A1. Individual contacts") +
  theme_bw() +
  theme(plot.title = element_text(size=12),
        axis.ticks.x = element_blank(),
        plot.background = element_blank())

total_time_all_sch <- ggplot(
  contacts %>% filter(cnt_mass == "individual"), 
  aes(y = went_to_school, fill = factor(cnt_total_time))) + 
  geom_bar(position="fill", stat="count") +
  facet_grid(.~wave_id, scale = "free", switch = "both") +
  ylab("Did child go to school the day before survey?") +
  xlab("Proportion") +
  labs(fill = "Contact time") +
  scale_y_discrete(expand = c(0,0)) + scale_x_continuous(expand = c(0,0)) +
  coord_flip() +
  # scale_fill_manual(values = rev(fresh_pallette[c(2:6,8)]), guide = guide_legend(reverse = TRUE)) +
  ggtitle("A2. Individual contacts") +
  theme_bw() +
    theme(plot.title = element_text(size=12),
        strip.background = element_blank(), 
        axis.text.x = element_text(angle=-5),  
        axis.ticks.x = element_blank())

total_time_non_household <- ggplot(
  contacts %>% filter(cnt_mass == "individual" & cnt_household == 0), 
  aes(y = factor(wave_id), fill = factor(cnt_total_time))) + 
  geom_bar(position="fill", stat="count") +
  ylab("") +
  xlab("Proportion") +
  labs(fill = "Contact time") +
  scale_y_discrete(expand = c(0,0)) + scale_x_continuous(expand = c(0,0)) +
  coord_flip() +
  # scale_fill_manual(values = rev(fresh_pallette[c(2:6,8)]), guide = guide_legend(reverse = TRUE)) +
  ggtitle("B1. Non-household contacts") +
  theme_bw() +
  theme(plot.title = element_text(size=12),
        axis.ticks.x = element_blank(),
        plot.background = element_blank())

total_time_non_household_sch <- ggplot(
  contacts %>% filter(cnt_mass == "individual" & cnt_household == 0), 
  aes(y = went_to_school, fill = factor(cnt_total_time))) + 
  geom_bar(position="fill", stat="count") +
  facet_grid(.~wave_id, scale = "free", switch = "both") +
  ylab("Did child go to school the day before survey?") +
  xlab("Proportion") +
  labs(fill = "Contact time") +
  scale_y_discrete(expand = c(0,0)) + scale_x_continuous(expand = c(0,0)) +
  coord_flip() +
  # scale_fill_manual(values = rev(fresh_pallette[c(2:6,8)]), guide = guide_legend(reverse = TRUE)) +
  ggtitle("B2. Non-household contacts") +
  theme_bw() +
  theme(plot.title = element_text(size=12),
        strip.background = element_blank(), 
        axis.text.x = element_text(angle=-5),  
        axis.ticks.x = element_blank())

# total_time_non_household 

comb_total_time <- (total_time_all + total_time_non_household +
                    total_time_all_sch + total_time_non_household_sch) + plot_layout(guides = "collect")

comb_total_time 

cnt_summary_duration <- contacts %>%
  filter(cnt_mass == "individual") %>%
  count(wave_sch_id, cnt_total_time) %>%
  group_by(wave_sch_id) %>%
  mutate(prop = round(prop.table(n), 3)) %>%
  mutate(display = paste(n, " (", format_n(prop * 100), "%)", sep = "")) %>%
  pivot_wider(id_cols = "cnt_total_time", names_from = "wave_sch_id", values_from = "display", names_prefix = "Wave ")  %>%
  rename("Group" = cnt_total_time) %>%
  mutate(Category = "Contact time") %>%
  relocate(Category, .before = Group)

cnt_summary_duration_c <- contacts %>%
  filter(panel == "C") %>% 
  filter(cnt_mass == "individual") %>%
  count(wave_id, cnt_total_time) %>%
  group_by(wave_id) %>%
  mutate(prop = round(prop.table(n), 3)) %>%
  mutate(display = paste(n, " (", format_n(prop * 100), "%)", sep = "")) %>%
  pivot_wider(id_cols = "cnt_total_time", names_from = "wave_id", values_from = "display", names_prefix = "Wave ")  %>%
  rename("Group" = cnt_total_time) %>%
  mutate(Category = "Contact time") %>%
  relocate(Category, .before = Group)

cnt_summary_duration <- merge(cnt_summary_duration, cnt_summary_duration_c, 
                              by = c("Category", "Group")) %>% 
  relocate("Wave C1", .before = "Wave C1 NA") %>% 
  relocate("Wave C2", .before = "Wave C2 NA") 

# kable(cnt_summary_duration)  %>% kable_styling(full_width = F, position = "left")

```

<br/>

```{r cnt_summary_table, echo = FALSE}
cnt_summary_table <- rbindlist(list(cnt_summary_setting, cnt_summary_duration))

kable(cnt_summary_table) %>% 
  kable_styling(full_width = F, position = "left", font_size = 12) %>%
  column_spec(which(names(cnt_summary_table)=="Wave C1"), bold = T) %>%
  column_spec(which(names(cnt_summary_table)=="Wave C2"), bold = T) %>% 
  collapse_rows(columns = 1, valign = "top") 
  
```

<strong>Table 3. Contacts by setting and duration of contact and wave.</strong> Number and percentage of contacts by category for all contacts (individually-reported and reported in aggregated contact questions).

<br/>

#### Contact means

<br/>

<strong>Figure 4. Crude mean contacts by participant age group and wave.</strong>   Reported by all contacts and contacts truncated to 50 per participant per day.

```{r contact_means_plot, echo=FALSE, message = FALSE, warning = FALSE}
wave_levels <- levels(unique(arrange(part_contacts, survey_round)$wave_id))
#wave_levels <- c(wave_levels, "C1 Yes", "C1 No", "C2 Yes", "C2 No")

all_mean <- part_contacts %>% 
  group_by(wave_id, part_id) %>%
  summarize(n = sum(cnt_any, na.rm = T)) %>%
  group_by(wave_id) %>%
  summarise("Mean contacts" = mean(n)) %>%
  mutate(Contacts = "All contacts", "Participant age" = "All") %>% 
  mutate(went_to_school = "All") %>% 
  relocate("Participant age", .after = went_to_school)

all_mean_sch <- part_contacts %>% 
  filter(panel == "C") %>% 
  filter(went_to_school %in% c("Yes", "No")) %>% 
  filter(!is.na(part_age_group)) %>% 
  group_by(wave_id, went_to_school, part_id) %>%
  summarize(n = sum(cnt_any, na.rm = T)) %>%
  group_by(wave_id, went_to_school) %>%
  summarise("Mean contacts" = mean(n)) %>%
  mutate(Contacts = "All contacts", "Participant age" = "All") %>% 
  relocate("Participant age", .after = went_to_school)

trunc_mean <- trunc_part_contacts %>% 
  group_by(wave_id, part_id) %>%
  summarize(n = sum(cnt_any, na.rm = T)) %>%
  summarise("Mean contacts" = mean(n)) %>%
  mutate(Contacts = "Truncated to 50 contacts/participant", "Participant age" = "All") %>% 
  mutate(went_to_school = "All") %>% 
  relocate("Participant age", .after = went_to_school)

trunc_mean_sch <- trunc_part_contacts %>% 
  filter(panel == "C") %>% 
  filter(went_to_school %in% c("Yes", "No")) %>% 
  filter(!is.na(part_age_group)) %>% 
  group_by(wave_id, went_to_school, part_id) %>%
  summarize(n = sum(cnt_any, na.rm = T)) %>%
  summarise("Mean contacts" = mean(n)) %>%
  mutate(Contacts = "Truncated to 50 contacts/participant", "Participant age" = "All") %>% 
  relocate("Participant age", .after = went_to_school)

all_mean_age <- part_contacts %>% 
  filter(!is.na(part_age_group)) %>% 
  group_by(wave_id, part_id, part_age_group) %>%
  summarize(n = sum(cnt_any, na.rm = T)) %>%
  group_by(wave_id, part_age_group) %>%
  summarise("Mean contacts" = mean(n)) %>%
  mutate(Contacts = "All contacts") %>% 
  rename("Participant age" = part_age_group) %>% 
  mutate(went_to_school = "All") 

all_mean_age_sch <- part_contacts %>% 
  filter(panel == "C") %>% 
  filter(went_to_school %in% c("Yes", "No")) %>% 
  filter(!is.na(part_age_group)) %>% 
  group_by(wave_id, went_to_school, part_id, part_age_group) %>%
  summarize(n = sum(cnt_any, na.rm = T)) %>%
  group_by(wave_id, went_to_school, part_age_group) %>%
  summarise("Mean contacts" = mean(n)) %>%
  mutate(Contacts = "All contacts") %>% 
  rename("Participant age" = part_age_group) 

trunc_mean_age <- trunc_part_contacts %>% 
  filter(!is.na(part_age_group)) %>% 
  group_by(wave_id, part_id, part_age_group) %>%
  summarize(n = sum(cnt_any, na.rm = T)) %>%
  group_by(wave_id, part_age_group) %>%
  summarise("Mean contacts" = mean(n)) %>%
  mutate(Contacts = "Truncated to 50 contacts/participant") %>% 
  rename("Participant age" = part_age_group) %>% 
  mutate(went_to_school = "All") 

trunc_mean_age_sch <- trunc_part_contacts %>% 
  filter(panel == "C") %>% 
  filter(went_to_school %in% c("Yes", "No")) %>% 
  filter(!is.na(part_age_group)) %>% 
  group_by(wave_id, went_to_school, part_id, part_age_group) %>%
  summarize(n = sum(cnt_any, na.rm = T)) %>%
  group_by(wave_id, went_to_school, part_age_group) %>%
  summarise("Mean contacts" = mean(n)) %>%
  mutate(Contacts = "Truncated to 50 contacts/participant") %>% 
  rename("Participant age" = part_age_group) 

contact_means <- rbindlist(list(all_mean, trunc_mean, 
                                all_mean_age, all_mean_age_sch, 
                                trunc_mean_age, trunc_mean_age_sch), use.names = T) %>%
  rename(Wave = wave_id) %>%
  mutate("Mean contacts"= round(`Mean contacts`, 2)) %>%
  select("Wave", "Contacts", "Participant age", "Mean contacts", "went_to_school") 

contact_means_table <- contact_means %>%
  mutate(went_to_school = ifelse(!Wave %in% c("C1", "C2"), "", went_to_school)) %>% 
  pivot_wider(id_cols = c("Contacts",`Participant age`), 
              names_from = c("Wave", "went_to_school"),
              values_from = "Mean contacts", 
              names_prefix = "Wave ") 

contact_means_ages <- contact_means %>% filter(`Participant age` != "All") %>%  
  mutate(age_panel = case_when(
    `Participant age` %in% c("0-4") ~ "Younger children",
    `Participant age` %in% c("5-17") ~ "Older children",
    `Participant age` %in% c("18-29", "30-39", "40-49", "50-59") ~ "Adults",
    `Participant age` %in% c("60-69", "70+", "60+") ~ "Older adults"
  )) %>%
  mutate(age_panel = factor(age_panel, levels = c("Younger children", "Older children", "Adults", "Older adults"))) %>%
  mutate(Wave = factor(paste("Wave", Wave), levels = paste("Wave", wave_levels))) 

# ggplot(contact_means_ages, aes(x = `Participant age`, y = `Mean contacts`,
#                                fill = `Participant age`)) +
#   geom_col(position = "dodge") +
#   xlab("Partcipant age") +
#   facet_grid(rows = vars(Contacts), cols = vars(factor(Wave))) +
#   theme_bw() +
#   ylab("Mean number of contacts") +
#   theme(axis.text.x = element_text(angle = 90, vjust = 0.3))  
# contact_means_ages %>% filter(Contacts == "Truncated to 50 contacts/participant")


ggplot(contact_means_ages, 
       aes(x = factor(Wave), y = `Mean contacts`, 
           group=interaction(factor(`Participant age`), went_to_school),
           color=interaction(factor(`Participant age`)))) +
  geom_line(aes(linetype = went_to_school), alpha = 0.7) +
  geom_point(alpha = 0.8) +
  facet_grid(rows = vars(Contacts), cols = vars(age_panel), scales = "free_y") +
  expand_limits(y = 0) +
  scale_color_gdocs() +
  xlab("Wave") +
  ylab("Mean number of contacts") +
  labs(color = "Participant age") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.3))  


```

<br/>

```{r contact_means_table}
kable(contact_means_table) %>%
  kable_styling(full_width = F, position = "left") %>%
  collapse_rows(columns = 1, valign = "top") 
```
<strong>Table 4. Crude mean contacts by participant age group for each wave.</strong>

<br/>

### Contact Matrices

<br/>

#### All contacts

<br/>

<strong>Figure 5. Contact matrices by wave.</strong> Contacts truncated to 50 per participant per day, adjusted for day of week.

```{r contact_matrices, echo=FALSE}
# Plot generated in `r/socialmixr_matrices.R`
source(file.path(here::here(), "r", "socialmixr_matrices.R"))

cm_plot_all
```

<br/>

<strong>Figure 6. Adjusted contact means by participant age group.</strong> Contacts truncated to 50 per participant per day, adjusted for day of week.

```{r adjusted_mean_figure, fig.height = 3, fig.width = 10}
# 
# ggplot(adj_mean_contacts_all, aes(y = mean_contacts, x = participant_age,
#                               fill = participant_age)) +
#   geom_col() +
#   facet_grid(cols = vars(wave)) +
#   xlab("Participant age") +
#   ylab("Mean contacts") +
#   labs(fill = "Participant age") +
#   scale_fill_ptol() +
#   theme_bw() +
#   theme(axis.text.x = element_text(angle = 90, vjust = 0.3))

adj_mean_contacts_all <- adj_mean_contacts_all %>% 
  mutate(age_panel = case_when(
    as.character(participant_age) %in% c("0-4", "5-11", "12-17") ~ "Children",
    as.character(participant_age) %in% c("18-29", "30-39", "40-49", "50-59") ~ "Adults",
    as.character(participant_age) %in% c("60-69", "70+", "60+") ~ "Older adults"
  )) %>%
   # mutate(age_panel = factor(age_panel, levels = c("Children", "Adults", "Older adults"))) %>%
  mutate(wavef = factor(wave, levels = paste("Wave", wave_levels))) %>%
  mutate(panel = gsub("Wave|[0-9]", "", wave)) %>%
  mutate(age_panel = as.character(age_panel))

ggplot(adj_mean_contacts_all %>% filter(wavef != "Wave C1" & age_panel != "Children"), aes(x = factor(wavef), y = mean_contacts)) +
    geom_point(aes(group = factor(participant_age), color = factor(participant_age)), alpha = 0.8) +

  geom_line(aes(group = participant_age, color = participant_age), alpha = 0.7)  +
  facet_grid(rows = vars(age_panel)) +
  expand_limits(y = 0) +
  scale_color_gdocs() +
  xlab("Wave") +
  ylab("Mean number of contacts") +
  labs(color = "Participant age") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.3))

  
```

<br/>

<strong>Table 5. Adjusted contact means by participant age group.</strong> Contacts truncated to 50 per participant per day, adjusted for day of week.

```{r adjusted_mean_table_all}
kable(adj_mean_contacts_table_all, digits = 2) %>% kable_styling(full_width = F, position = "left")
```


<br/>


#### Combined contacts

<br/>

<strong>Figure 7. Symmetric combined matrices by wave.</strong> Adult survey waves each combined with the single round of data collection for children's contacts (wave C1) to provide an estimate of overall contacts. Children's contacts may have changed over time, especially depending on school attendence status. Contacts truncated to 50 per participant per day, adjusted for day of week and country population by age using the World Population Prospect population data.

```{r contact_matrices_adult, echo=FALSE}
# Plot generated in `r/socialmixr_matrices.R`

cm_plot_adult
```

<br/>


<strong>Figure 8. Combined contact means by wave.</strong> Contact means as calculated from symmetric, combined symmetric matrices. Adult survey waves each combined with the single round of data collection for children's contacts (wave C1) to provide an estimate of overall contacts. Children's contacts may have changed over time, especially depending on school attendence status. Contacts truncated to 50 per participant per day, adjusted for day of week and country population by age using the World Population Prospect population data.

```{r adjusted_mean_figure_adult, fig.height = 3, fig.width = 10}

# ggplot(adj_mean_contacts_adult, aes(y = mean_contacts, x = participant_age,
#                               fill = participant_age)) +
#   geom_col() +
#   facet_grid(cols = vars(wave)) + 
#   xlab("Participant age") +
#   ylab("Mean contacts") +
#   labs(fill = "Participant age") +
#   theme_bw() 
#   theme(axis.text.x = element_text(angle = 90, vjust = 0.3))  
adj_mean_contacts_adult <- adj_mean_contacts_adult %>% 
  mutate(age_panel = case_when(
    participant_age %in% c("0-4", "5-11", "12-17") ~ "Children",
    participant_age %in% c("18-29", "30-39", "40-49", "50-59") ~ "Adults",
    participant_age %in% c("60-69", "70+", "60+") ~ "Older adults"
  )) %>%
   mutate(age_panel = factor(age_panel, levels = c("Children", "Adults", "Older adults"))) %>%
  mutate(wavef = factor(wave, levels = paste("Wave", wave_levels))) %>%
  mutate(panel = gsub("Wave|[0-9]", "", wave)) 

# ggplot(adj_mean_contacts_adult, aes(x = factor(wavef), y = mean_contacts)) +
#   geom_line(aes(group = factor(participant_age), color = factor(participant_age)), alpha = 0.7) +
#   geom_point(aes(group = factor(participant_age), color = factor(participant_age)), alpha = 0.8) +
#   facet_grid(rows = vars(panel), scales = "free_x") +
#   expand_limits(y = 0) +
#   scale_color_gdocs() +
#   xlab("Wave") +
#   ylab("Mean number of contacts") +
#   labs(color = "Participant age") +
#   theme_bw() +
#   theme(axis.text.x = element_text(angle = 90, vjust = 0.3))  


adj_mean_contacts_adult <- adj_mean_contacts_adult %>% 
  mutate(age_panel = case_when(
    as.character(participant_age) %in% c("0-4", "5-11", "12-17") ~ "Children",
    as.character(participant_age) %in% c("18-29", "30-39", "40-49", "50-59") ~ "Adults",
    as.character(participant_age) %in% c("60-69", "70+", "60+") ~ "Older adults"
  )) %>%
   # mutate(age_panel = factor(age_panel, levels = c("Children", "Adults", "Older adults"))) %>%
  mutate(wavef = factor(wave, levels = paste("Wave", wave_levels))) %>%
  mutate(panel = gsub("Wave|[0-9]", "", wave)) %>%
  mutate(age_panel = as.character(age_panel))

ggplot(adj_mean_contacts_adult %>% filter(wavef != "Wave C1" & age_panel != "Children"), aes(x = factor(wavef), y = mean_contacts)) +
    geom_point(aes(group = factor(participant_age), color = factor(participant_age)), alpha = 0.8) +

  geom_line(aes(group = participant_age, color = participant_age), alpha = 0.7)  +
  facet_grid(rows = vars(age_panel)) +
  expand_limits(y = 0) +
  scale_color_gdocs() +
  xlab("Wave") +
  ylab("Mean number of contacts") +
  labs(color = "Participant age") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.3))


# ggthemr::ggthemr("grape")
# ggplot(adj_mean_contacts_adult, 
#        aes(y = mean_contacts, 
#            x = wave,
#            group = participant_age, 
#            color = participant_age)) +
#   geom_point() +
#   geom_line() +
#   expand_limits(y = 0) +
#   facet_wrap(vars(participant_age)) +
#   xlab("Wave") +
#   ylab("Mean contacts") +
#   labs(color = "Participant age") +
#   theme_bw() +
#   theme(axis.text.x = element_text(angle = 90, vjust = 0.3))  
  
```

<br/>

<strong>Table 6.Participant contact means by wave.</strong> Contact means as calculated from symmetric, participant to contact symmetric matrices. Adult survey waves each combined with the single round of data collection for children's contacts (wave C1) to provide an estimate of overall contacts. Children's contacts may have changed over time, especially depending on school attendence status. Contacts truncated to 50 per participant per day, adjusted for day of week and country population by age using the World Population Prospect population data.

```{r adjusted_mean_table_adult}
kable(adj_mean_contacts_table_adult, digits = 2) %>% kable_styling(full_width = F, position = "left")
```


<br/>

#### References

1.  Jarvis CI, Van Zandvoort K, Gimma A, Prem K, CMMID COVID-19 working group, Klepac P, et al. Quantifying the impact of physical distance measures on the transmission of COVID-19 in the UK. BMC Med. 2020;18: 124.

2.  Coletti P, Wambua J, Gimma A, Willem L, Vercruysse S, Vanhoutte B, et al. CoMix: comparing mixing patterns in the Belgian population during and after lockdown. Sci Rep. 2020 Dec;10(1):21885. 

3. 	Mossong J, Hens N, Jit M, Beutels P, Auranen K, Mikolajczyk R, et al. Social contacts and mixing patterns relevant to the spread of infectious diseases. PLoS Med. 2008;5: e74. 

4. Sebastian Funk (2020). socialmixr: Social Mixing Matrices for Infectious Disease Modelling. R package version 0.1.7.
